{% macro render_stars(rating) -%}
  {% if rating is none %}
    ‚Äî
  {% else %}
    {% set full = rating|float|int %}
    {% for _ in range(full) %}‚òÖ{% endfor %}
    {% for _ in range(5 - full) %}‚òÜ{% endfor %}
    <small style="color:#666;margin-left:6px;">({{ rating }})</small>
  {% endif %}
{%- endmacro %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ profile.username }} ‚Äî Profile</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <header class="topbar" style="max-width:1000px;margin:12px auto;padding:0 16px;">
    <a href="{{ url_for('index') }}">&larr; Home</a>
    <div class="brand">Book Search</div>
    <div class="top-actions">
      {# if a profile_id cookie is present show avatar linking to profile, otherwise show login link #}
      {% if request.cookies.get('profile_id') %}
        <a class="profile-link" href="{{ url_for('profile', profile_id=request.cookies.get('profile_id')) }}">
          <img class="avatar" src="{{ url_for('static', filename='img/default-avatar.png') }}"
               alt="{{ request.cookies.get('username') or 'Profile' }}" loading="lazy">
        </a>
      {% else %}
        <a class="signin" href="{{ url_for('login') }}">Log in</a>
      {% endif %}
    </div>
  </header>

  <main style="max-width:720px;margin:24px auto;padding:16px;">
    <div style="display:flex;align-items:center;gap:16px;">
      <img src="{{ url_for('static', filename='img/default-avatar.png') }}" alt="{{ profile.username }}"
           style="width:72px;height:72px;border-radius:50%;object-fit:cover;border:1px solid #ddd;">
      <div>
        <h1 style="margin:0">{{ profile.username }}</h1>
        <p style="margin:6px 0 0;color:#666">Joined: {{ profile.joined_at }}</p>
      </div>
    </div>

    {% if current_user_id and current_user_id != profile.profile_id %}
      <form method="post" style="margin-top:16px;">
        {% if is_following %}
          <button type="submit" name="action" value="unfollow"
                  style="padding:8px 12px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer;">
            Unfollow
          </button>
        {% else %}
          <button type="submit" name="action" value="follow"
                  style="padding:8px 12px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer;">
            Follow
          </button>
        {% endif %}
      </form>
    {% elif current_user_id == profile.profile_id %}
      <!-- logout form -->
      <form method="post" action="{{ url_for('logout') }}" style="margin-top:16px;">
        <button type="submit" style="padding:8px 12px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer;">
          Log out
        </button>
      </form>
    {% endif %}

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-top:1em;">
      <!-- Followers -->
      <details>
        <summary style="cursor:pointer;font-weight:bold;">
          Followers ({{ followers_count }})
        </summary>
        <ul>
          {% for f in followers %}
            <li><a href="{{ url_for('profile', profile_id=f.id) }}">{{ f.username }}</a></li>
          {% endfor %}
        </ul>
      </details>

      <!-- Following -->
      <details>
        <summary style="cursor:pointer;font-weight:bold;">
          Following ({{ following_count }})
        </summary>
        <ul>
          {% for f in following %}
            <li><a href="{{ url_for('profile', profile_id=f.id) }}">{{ f.username }}</a></li>
          {% endfor %}
        </ul>
      </details>

      <!-- Book Reviews -->
      <details>
        <summary style="cursor:pointer;font-weight:bold;">
          Reviews ({{ reviews|length }})
        </summary>
        <ul>
          {% for r in reviews %}
            <li style="margin-bottom:1em;">
              <a href="{{ url_for('book', book_id=r.id) }}#review-{{ profile.profile_id }}">
                {{ r.title }}
              </a>
              {% if r.rating %}
                {{ render_stars(r.rating) }}
              {% endif %}
              {% if r.review_text %}
                <div style="margin-top:4px; color:#444;">{{ r.review_text }}</div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </details>

      <!-- Favorite Authors -->
      <details>
        <summary style="cursor:pointer;font-weight:bold;">
          Favorite Authors ({{ favorite_authors|length }})
        </summary>
        <ul>
          {% for a in favorite_authors %}
            <li><a href="{{ url_for('author', author_id=a.id) }}">{{ a.name }}</a></li>
          {% endfor %}
        </ul>
      </details>

      <!-- Tracked Books -->
      <details>
        <summary style="cursor:pointer;font-weight:bold;">
          Tracked Books ({{ tracked_books|length }})
        </summary>
        <ul>
          {% for b in tracked_books %}
            <li>
              <a href="{{ url_for('book', book_id=b.id) }}">{{ b.title }}</a>
              ‚Äî Status: {{ b.status }}
            </li>
          {% endfor %}
        </ul>
      </details>
    </div>

    <!-- add bookshelves list -->
    <section style="margin-top:20px;">
      <h2 style="margin-bottom:8px;">Bookshelves</h2>

      {% if is_owner %}
      <details class="create-shelf" style="margin-bottom:12px;">
        <summary style="cursor:pointer;padding:10px;border:1px solid #eee;border-radius:6px;background:#fff;font-weight:600;">
          Create bookshelf
        </summary>

        <form method="post" action="{{ url_for('create_bookshelf') }}" style="margin-top:8px;padding:10px;border:1px solid #eee;border-radius:6px;background:#fafafa;">
          <div style="display:flex;gap:8px;align-items:flex-start;">
            <div style="flex:1;">
              <label style="display:block;font-weight:600;margin-bottom:6px;">Shelf name
                <input name="shelf_name" type="text" required placeholder="Shelf name" style="width:100%;padding:6px;margin-top:6px;box-sizing:border-box;">
              </label>
              <label style="display:block;margin-top:6px;">Description
                <textarea name="description" rows="2" style="width:100%;padding:6px;margin-top:6px;box-sizing:border-box;"></textarea>
              </label>
            </div>

            <div style="min-width:120px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
              <label style="font-size:0.9rem;">
                <input type="checkbox" name="is_public" checked>
                Public
              </label>
              <button type="submit" style="padding:8px 12px;">Create</button>
            </div>
          </div>
        </form>
      </details>
      {% endif %}

      {% if bookshelves %}
        <ul style="list-style:none;padding:0;margin:0;display:grid;gap:12px;">
          {% for bs in bookshelves %}
            <li style="padding:10px;border:1px solid #eee;border-radius:6px;">
              <div style="display:flex;align-items:center;gap:12px;">
                <div style="flex:1;">
                  {% if has_view_bookshelf %}
                    <a href="{{ url_for('view_bookshelf', bookshelf_id=bs.id) }}" style="font-weight:600;">
                      {{ bs.name }}
                    </a>
                  {% else %}
                    <span style="font-weight:600;">{{ bs.name }}</span>
                  {% endif %}
                  <div style="color:#666;font-size:0.9rem;margin-top:4px;">
                    {{ bs.created_at }}{% if not bs.is_public %} ‚Ä¢ private{% endif %}
                  </div>
                </div>

                {% if is_owner %}
                <div style="margin-left:12px;flex:0 0 auto;">
                  <form method="post" action="{{ url_for('delete_bookshelf', bookshelf_id=bs.id) }}"
                        onsubmit="return confirm('Delete bookshelf &quot;{{ bs.name }}&quot;? This cannot be undone.');"
                        style="display:inline;">
                    <button type="submit" style="background:#fff;border:0px solid #e0e0e0;color:#b00020;padding:6px 8px;border-radius:4px;cursor:pointer;">
                      üóëÔ∏è
                    </button>
                  </form>
                </div>
                {% endif %}
              </div>
              {% if bs.description %}
                <p style="margin:8px 0 0;color:#444;">{{ bs.description }}</p>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        {% if is_owner %}
          <p style="color:#666;">You haven't created any bookshelves yet.</p>
        {% else %}
          <p style="color:#666;">This user has no public bookshelves.</p>
        {% endif %}
      {% endif %}
    </section>
  </main>
</body>
</html>