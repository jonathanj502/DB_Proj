<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ book.title if book else "Book" }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <p><a href="{{ url_for('index') }}">&larr; Home</a></p>

  {% if not book %}
    <p>Book not found.</p>
  {% else %}
    <div class="book-page">
      <div class="book-cover">
        {% if book.image_url %}
          <img src="{{ book.image_url }}" alt="{{ book.title }}" class="thumb" onerror="this.style.display='none'">
        {% else %}
          <div class="thumb placeholder">No image</div>
        {% endif %}
      </div>

      <div class="book-info">
        <h1>{{ book.title }}</h1>

        {% if book.authors %}
          <p class="byline">
            By
            {% if book.authors is iterable and book.authors[0] is mapping %}
              {% for a in book.authors %}
                {% if a.id %}
                  <a href="{{ url_for('author', author_id=a.id) }}">{{ a.name }}</a>{% if not loop.last %}, {% endif %}
                {% else %}
                  {{ a.name }}{% if not loop.last %}, {% endif %}
                {% endif %}
              {% endfor %}
            {% else %}
              {{ book.authors }}
            {% endif %}
          </p>
        {% endif %}

        {% if book.summary %}
          <h3>Summary</h3>
          <p class="summary">{{ book.summary }}</p>
        {% endif %}

        <ul class="meta">
          <li><strong>Published:</strong> {{ book.published_year or 'N/A' }}</li>
          <li><strong>Pages:</strong> {{ book.page_count or 'N/A' }}</li>
          <li><strong>Language:</strong> {{ book.language or 'N/A' }}</li>

          {# Genres line: show comma-separated list or N/A #}
          <li>
            <strong>Genres:</strong>
            {% if genres %}
              {{ genres | join(', ') }}
            {% else %}
              N/A
            {% endif %}
          </li>
        </ul>

        <!-- Tracking UI -->
        {% if request.cookies.get('profile_id') %}
          <div style="margin-top:12px;">
            {% if tracking %}
              <div style="margin-bottom:8px;color:#333;">
                Tracking: <strong>{{ tracking.status }}</strong>{% if tracking.current_page %} — page {{ tracking.current_page }}{% endif %}
              </div>

              <form method="post" action="{{ url_for('track_book', book_id=book.id) }}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <label style="display:flex;gap:6px;align-items:center;">
                  <span>Status</span>
                  <select name="status" style="padding:6px;border:1px solid #ddd;border-radius:4px;">
                    {% for s in ['planning','reading','on-hold','finished'] %}
                      <option value="{{ s }}" {% if tracking.status == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                  </select>
                </label>

                <label style="display:flex;gap:6px;align-items:center;">
                  <span>Page</span>
                  <input name="current_page" type="number" min="0" value="{{ tracking.current_page or 0 }}" style="width:96px;padding:6px;border:1px solid #ddd;border-radius:4px;">
                </label>

                <button type="submit" style="padding:6px 10px;border-radius:4px;">Save</button>
              </form>

              <form method="post" action="{{ url_for('untrack_book', book_id=book.id) }}" style="margin-top:8px;">
                <button type="submit" style="background:#fff;border:1px solid #e0e0e0;color:#b00020;padding:6px 8px;border-radius:4px;cursor:pointer;">
                  Stop tracking
                </button>
              </form>

            {% else %}
              <form method="post" action="{{ url_for('track_book', book_id=book.id) }}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <label style="display:flex;gap:6px;align-items:center;">
                  <span>Status</span>
                  <select name="status" style="padding:6px;border:1px solid #ddd;border-radius:4px;">
                    <option value="reading" selected>reading</option>
                    <option value="planning">planning</option>
                    <option value="on-hold">on-hold</option>
                    <option value="finished">finished</option>
                  </select>
                </label>

                <button type="submit" style="padding:6px 10px;border-radius:4px;">Track</button>
              </form>
            {% endif %}
          </div>
        {% else %}
          <p style="margin-top:12px;"><a href="{{ url_for('login') }}">Log in</a> to track this book.</p>
        {% endif %}

      </div>
    </div>

    <!-- Reviews -->
    <div class="reviews-section">
      <h3>Reviews</h3>

      {# review form shown only when logged in #}
      {% if request.cookies.get('profile_id') %}
        <form method="post" action="{{ url_for('post_review', book_id=book.id) }}" class="review-form">
          <div>
            <label for="rating">Rating</label><br>

            <!-- hidden field that will be submitted -->
            <input type="hidden" id="rating" name="rating" value="">

            <!-- clickable star row -->
            <div class="star-input" role="radiogroup" aria-label="Rating">
              <span class="star" data-value="1" role="radio" aria-checked="false" tabindex="0">☆</span>
              <span class="star" data-value="2" role="radio" aria-checked="false" tabindex="0">☆</span>
              <span class="star" data-value="3" role="radio" aria-checked="false" tabindex="0">☆</span>
              <span class="star" data-value="4" role="radio" aria-checked="false" tabindex="0">☆</span>
              <span class="star" data-value="5" role="radio" aria-checked="false" tabindex="0">☆</span>
            </div>

            <style>
              .star-input { display:inline-flex; gap:6px; align-items:center; font-size:1.4rem; }
              .star-input .star { cursor:pointer; user-select:none; color:#ccc; transition:color .12s ease; outline:none; }
              .star-input .star.hover,
              .star-input .star.selected { color:#f5b301; }
              .star-input .star:focus { box-shadow:0 0 0 3px rgba(245,179,1,0.12); border-radius:4px; }
            </style>

            <script>
              (function(){
                const stars = Array.from(document.querySelectorAll('.star-input .star'));
                const hidden = document.getElementById('rating');
                let selected = 0;

                function updateVisual(n){
                  stars.forEach((s, i) => {
                    s.classList.toggle('selected', i < n);
                    s.setAttribute('aria-checked', i < n ? 'true' : 'false');
                    s.textContent = i < n ? '★' : '☆';
                  });
                }

                stars.forEach((star, idx) => {
                  const val = idx + 1;

                  star.addEventListener('click', () => {
                    selected = val;
                    hidden.value = selected;
                    updateVisual(selected);
                  });

                  star.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ') {
                      ev.preventDefault();
                      selected = val;
                      hidden.value = selected;
                      updateVisual(selected);
                    }
                    if (ev.key === 'ArrowLeft' || ev.key === 'ArrowDown') {
                      ev.preventDefault();
                      const prev = Math.max(1, (selected || val) - 1);
                      selected = prev;
                      hidden.value = selected;
                      updateVisual(selected);
                      stars[selected-1].focus();
                    }
                    if (ev.key === 'ArrowRight' || ev.key === 'ArrowUp') {
                      ev.preventDefault();
                      const next = Math.min(5, (selected || val) + 1);
                      selected = next;
                      hidden.value = selected;
                      updateVisual(selected);
                      stars[selected-1].focus();
                    }
                  });

                  star.addEventListener('mouseover', () => {
                    const n = val;
                    stars.forEach((s, i) => {
                      s.classList.toggle('hover', i < n);
                      s.textContent = i < n ? '★' : '☆';
                    });
                  });

                  star.addEventListener('mouseout', () => {
                    stars.forEach(s => s.classList.remove('hover'));
                    updateVisual(selected);
                  });
                });

                // initialize if there's a preselected value (e.g. editing)
                if (hidden.value) {
                  selected = parseInt(hidden.value, 10) || 0;
                  updateVisual(selected);
                }
              })();
            </script>
          </div>
          
          <div>
            <label for="review_text">Your review</label><br>
            <textarea id="review_text" name="review_text" rows="4" cols="60" placeholder="Write your review (optional)"></textarea>
          </div>
          <div style="margin-top:8px;">
            <button type="submit">Submit review</button>
          </div>
          <p style="font-size:0.9em;color:#666;margin-top:6px;">
            Note: either a rating or review text is required.
          </p>
        </form>
      {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to write a review.</p>
      {% endif %}

      <hr>

      {# helper to render stars for a stored rating #}
      {% macro render_stars(rating) -%}
        {% if rating is none %}
          —
        {% else %}
          {% set full = rating|float|int %}
          {% for _ in range(full) %}★{% endfor %}
          {% for _ in range(5 - full) %}☆{% endfor %}
          <small style="color:#666;margin-left:6px;">({{ rating }})</small>
        {% endif %}
      {%- endmacro %}

      {% if reviews %}
        {% for r in reviews %}
          <div class="review">
            <div class="review-meta" style="display:flex;align-items:center;gap:12px;">
              <strong>
                <a href="{{ url_for('profile', profile_id=r.profile_id) }}">
                  {{ r.username or ('User ' ~ r.profile_id) }}
                </a>
              </strong>
              <small style="color:#666;">{{ r.reviewed_at }}</small>
              <span style="margin-left:auto;color:#333;">
                {{ render_stars(r.rating) }}
              </span>
            </div>

            {% if r.review_text %}
              <p class="review-text" style="margin:6px 0 4px;">
                {{ r.review_text }}
              </p>
            {% endif %}

            <div class="review-actions" style="display:flex;gap:8px;align-items:center;">
              <form
                method="post"
                action="{{ url_for('like_review', book_id=book.id, profile_id=r.profile_id) }}">
                <button type="submit">
                  Like ({{ r.likes_count or 0 }})
                </button>
              </form>

              {% if request.cookies.get('profile_id') and request.cookies.get('profile_id')|int == r.profile_id %}
                <form
                  method="post"
                  action="{{ url_for('delete_review', book_id=book.id) }}"
                  style="margin-left:8px;">
                  <button type="submit">Delete</button>
                </form>
              {% endif %}
            </div>

            <hr style="margin-top:12px;">
          </div>
        {% endfor %}
      {% else %}
        <p>No reviews yet. Be the first to review this book!</p>
      {% endif %}
    </div>

  {% endif %}
</body>
</html>